generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core models
model User {
  id         String        @id @default(cuid())
  name       String
  email      String        @unique
  password   String
  role       Role          @default(TEACHER)
  avatarUrl  String?
  phone      String?
  genderId   String?       // id_genero
  gender     Gender?       @relation(fields: [genderId], references: [id])
  birthDate  DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  activities Activity[]
  tokens     RefreshToken[]
  decidedRequests SignupRequest[] @relation("UserDecisions")
  elaborations Elaboration[]
  ownedProjects Project[]
  teachingClasses TeacherClass[]
  passwordResets PasswordReset[]
  auditLogs AuditLog[]
}

model Student {
  id         String            @id @default(cuid())
  name       String
  email      String?           @unique
  registryId String?           @unique // matrícula opcional
  photoUrl   String?           // foto do aluno
  birthDate  DateTime?         // data_nasc
  phone      String?           // fone_contato
  addressId  String?           // id_endereco
  genderId   String?           // id_genero
  address    Address?          @relation(fields: [addressId], references: [id])
  gender     Gender?           @relation(fields: [genderId], references: [id])
  comorbidities String?         // comorbidade
  allergies     String?         // alergia
  medications   String?         // medicacao
  observations  String?         // obs
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  enrollments      Enrollment[]
  attendanceRecord AttendanceRecord[]
  grades           ActivityGrade[]
}

model Class {
  id        String       @id @default(cuid())
  name      String
  code      String       @unique
  year      Int
  disciplines String[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  enrollments  Enrollment[]
  attendance   AttendanceDay[]
  plannings    Planning[]
  activities   Activity[]
  projects     Project[]
  teachers     TeacherClass[]
}

model Enrollment {
  id        String   @id @default(cuid())
  classId   String
  studentId String
  startDate DateTime @default(now())
  endDate   DateTime?

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
}

model AttendanceDay {
  id        String      @id @default(cuid())
  classId   String
  date      DateTime
  notes     String?

  class   Class             @relation(fields: [classId], references: [id], onDelete: Cascade)
  records AttendanceRecord[]

  @@unique([classId, date])
}

model AttendanceRecord {
  id              String        @id @default(cuid())
  attendanceDayId String
  studentId       String
  status          AttendanceStatus
  observation     String?

  day     AttendanceDay @relation(fields: [attendanceDayId], references: [id], onDelete: Cascade)
  student Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([attendanceDayId, studentId])
}

model Planning {
  id            String        @id @default(cuid())
  classId       String
  kind          PlanningKind  @default(ANNUAL)
  title         String
  details       String?
  content       String?
  discipline    String?
  lessonsPlanned Int?
  date          DateTime?

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
}

model Activity {
  id          String      @id @default(cuid())
  classId     String
  teacherId   String
  title       String
  description String?
  dueDate     DateTime?
  maxScore    Float       @default(10)
  // Campos adicionais alinhados ao DER (atividade)
  discipline   String?    // disciplinas
  topic        String?    // tema
  methodology  String?    // metodologia
  explanation  String?    // explicacao
  content      String?    // conteudo
  indication   String?    // indicacao
  records      String?    // registros
  observations String?    // obs
  difficultyId String?
  category     ActivityCategory @default(SUBJECT)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher User  @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  grades  ActivityGrade[]
  difficulty Difficulty? @relation(fields: [difficultyId], references: [id])
  elaborations Elaboration[]
}

model ActivityGrade {
  id         String   @id @default(cuid())
  activityId String
  studentId  String
  score      Float
  feedback   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([activityId, studentId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  valid     Boolean  @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

// Password reset tokens
model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum Role {
  ADMIN
  TEACHER
  SECRETARY
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  JUSTIFIED
}

enum PlanningKind {
  ANNUAL
  SEMESTER
  INDIVIDUAL
}

model SignupRequest {
  id           String        @id @default(cuid())
  name         String
  email        String        @unique
  passwordHash String?
  roleRequested Role         @default(TEACHER)
  status       SignupStatus  @default(PENDING)
  reason       String?
  createdAt    DateTime      @default(now())
  decidedAt    DateTime?
  decidedById  String?
  decidedBy    User?         @relation("UserDecisions", fields: [decidedById], references: [id])
}

enum SignupStatus {
  PENDING
  APPROVED
  REJECTED
}

// Dificuldade (grau_dificuldade)
model Difficulty {
  id   String @id @default(cuid())
  type String

  activities Activity[]
}

// Elabora (anotações/relato de desenvolvimento por atividade e usuário)
model Elaboration {
  id         String   @id @default(cuid())
  activityId String
  userId     String
  text       String   // desenvolvimento
  createdAt  DateTime @default(now())

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([userId])
}

// Categoria de atividade para diferenciar matéria/projetos/multidisciplinares
enum ActivityCategory {
  SUBJECT
  MULTIDISCIPLINARY
  PROJECT_SUBJECT
  PROJECT_MULTIDISCIPLINARY
}

// Projetos dedicados (quando requisitos divergem de Activity)
model Project {
  id          String       @id @default(cuid())
  classId     String
  ownerId     String       // criador/responsável
  title       String
  description String?
  type        ProjectType  @default(SUBJECT)
  status      ProjectStatus @default(PLANNING)
  audience    String?      // público-alvo
  startDate   DateTime?
  endDate     DateTime?
  attachments Json?        // lista simples de anexos (urls/nomes)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  owner   User  @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  milestones ProjectMilestone[]
}

model ProjectMilestone {
  id        String   @id @default(cuid())
  projectId String
  title     String
  dueDate   DateTime?
  done      Boolean  @default(false)
  notes     String?

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum ProjectType {
  SUBJECT
  MULTIDISCIPLINARY
}

// Endereço (endereco)
model Address {
  id          String @id @default(cuid())
  street      String // rua
  number      Int    // numero
  complement  String? // complemento
  neighborhood String // bairro
  city        String // cidade
  state       String // estado
  country     String @default("Brasil") // pais
  zipCode     String // cep

  students Student[]
}

// Gênero (genero)
model Gender {
  id          String @id @default(cuid())
  description String // descricao

  students Student[]
  users    User[]
}
// Auditoria simples para rastrear mudanças críticas
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String
  metadata  Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  @@index([entity, entityId])
}

// Relação professor-turma, com disciplinas atribuídas
model TeacherClass {
  id         String   @id @default(cuid())
  teacherId  String
  classId    String
  disciplines String[]
  createdAt  DateTime @default(now())

  teacher User  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class   Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([teacherId, classId])
  @@index([classId])
}
